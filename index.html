<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Clash Royale Idle Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://fonts.cdnfonts.com/css/supercell-magic" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'Supercell Magic';
      src: url('fonts/SupercellMagicRegular.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    body { 
      font-family: 'Supercell Magic', Arial, sans-serif; 
      background: #2e3d53; 
      color: #fff; 
      margin: 0; 
      padding: 24px; 
      touch-action: manipulation; /* Prevent double-tap zoom on most browsers */
    }
    h1 {
      font-family: 'Supercell Magic', 'Arial Black', Arial, sans-serif;
      font-size: 1.7em;
      letter-spacing: 2px;
      color: #ffe066;
      text-shadow: 2px 2px 0 #2e3d53, 4px 4px 0 #b8860b;
      margin-bottom: 16px;
    }
    h2 {
  font-size: 1.1em;
  margin-bottom: 10px;
}
    .section,
    .section *:not(h1) {
      font-family: 'Supercell Magic', Arial, sans-serif !important;
    }
    button {
  margin: 4px;
  padding: 10px 22px;
  font-size: 1.1em;
  font-family: 'Supercell Magic', Arial, sans-serif;
  background: linear-gradient(180deg, #ffe066 0%, #ffb300 100%);
  color: #2e3d53;
  border: 3px solid #fffbe7;
  border-radius: 12px;
  box-shadow: 0 4px #b8860b, 0 2px 8px #0006;
  cursor: pointer;
  transition: transform 0.08s, box-shadow 0.08s, background 0.2s;
  text-shadow: 1px 1px 0 #fffbe7, 2px 2px 0 #b8860b;
  letter-spacing: 1px;
  position: relative;
}
button:active {
  transform: translateY(2px) scale(0.97);
  box-shadow: 0 2px #b8860b;
  background: linear-gradient(180deg, #ffd700 0%, #ff9800 100%);
}
button:hover {
  background: linear-gradient(180deg, #fffbe7 0%, #ffe066 100%);
  box-shadow: 0 6px #b8860b, 0 4px 12px #0008;
}
    .troop-controls { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .upgrade-section { background: #22304a; padding: 16px; border-radius: 8px; }
    .upgrade-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
  flex-wrap: wrap;
}
.upgrade-label {
  min-width: 120px;
  font-size: 1.1em;
  font-weight: bold;
  margin-bottom: 2px;
}
.upgrade-row button {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 1.1em;
  padding: 8px 16px;
}
.upgrade-row img {
  margin-left: 2px;
}
.info-icon {
  width: 20px;
  height: 20px;
  vertical-align: middle;
  margin-left: 8px;
  cursor: pointer;
  filter: brightness(1.2);
  transition: filter 0.2s;
}

.info-icon:hover {
  filter: brightness(1.5);
}

.popup {
  position: fixed;
  padding: 16px;
  background: #22304a;
  border: 3px solid #ffe066;
  border-radius: 12px;
  color: #fff;
  box-shadow: 0 4px 12px #0008;
  max-width: 280px;
  z-index: 100;
}
.upgrade-arena {
  background: #22304a;
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 16px;
  border: 2px solid #ffe066;
}

.upgrade-arena h3 {
  color: #ffe066;
  margin-top: 0;
}

#arenaUpgradeRequirements {
  margin: 12px 0;
  line-height: 1.5;
}

/* Add this to your existing styles */
.button-group {
  display: flex;
  gap: 8px;
  align-items: center;
}

.button-group button:last-child {
  font-size: 0.9em;
  padding: 8px 12px;
  background: linear-gradient(180deg, #ffd700 0%, #ff9800 100%);
}
  </style>
</head>
<body>
  <h1>Clash Royale Idle Game</h1>
  <div class="section">
    <h2>Goblin Stadium</h2>
    <div class="upgrade-arena" style="display: none;">
  <h3>Arena Upgrade Available!</h3>
  <p id="arenaUpgradeRequirements"></p>
  <button id="upgradeArenaBtn">Upgrade Arena</button>
</div>
    <p>Trophies: <span id="trophies">0</span></p>
    <p>Gold: <span id="gold">0</span></p>
    <p><span id="goldPerSec">0</span> gold/sec</p>
    <button id="mineGoldBtn">Mine Gold (+5)</button>
    <button id="battleBtn">Battle! (Cost: 500 gold)</button>
  </div>
  <div class="section">
    <h3>Troops Deployed for Battle</h3>
    <div id="troopList"></div>
    <p>Win Chance: <span id="winChance">50</span>%</p>
  </div>
  <div class="section upgrade-section">
    <h3>Troops & Upgrades</h3>
    <div class="upgrade-row">
      <div class="upgrade-label">
        Elixir Collector
        <img src="img/info.png" alt="info" class="info-icon" onclick="showInfo(this, 'Increases gold generation by 1 gold/sec')">
      </div>
      <div class="button-group">
        <button id="buyElixirBtn">
          50
          <img src="img/coin.png" alt="coin" width="20" height="20" style="vertical-align:middle;">
        </button>
        <button id="buyElixirBtn10x">
          500
          <img src="img/coin.png" alt="coin" width="20" height="20" style="vertical-align:middle;">
          x10
        </button>
      </div>
      <span>Elixir Collectors: <span id="elixirCount">0</span></span>
    </div>
    <div class="upgrade-row">
      <div class="upgrade-label">
        Goblins
        <img src="img/info.png" alt="info" class="info-icon" onclick="showInfo(this, 'Increases gold mined by 5%')">
      </div>
      <div class="button-group">
        <button id="buyGoblinBtn">
          100
          <img src="img/coin.png" alt="coin" width="20" height="20" style="vertical-align:middle;">
        </button>
        <button id="buyGoblinBtn10x">
          1000
          <img src="img/coin.png" alt="coin" width="20" height="20" style="vertical-align:middle;">
          x10
        </button>
      </div>
      <span>Goblins: <span id="goblinCount">0</span></span>
    </div>
  </div>
  <script>
const ARENAS = [
  { name: "Goblin Stadium", trophies: 0, cost: 0, troops: [], unlocks: null },
  { name: "Bone Pit", trophies: 300, cost: 5000, troops: [{type: "Goblins", required: 50}], unlocks: "Skeletons" },
  { name: "Barbarian Bowl", trophies: 600, cost: 10000, troops: [{type: "Skeletons", required: 100}], unlocks: "Barbarians" },
  { name: "Spell Valley", trophies: 1000, cost: 20000, troops: [{type: "Barbarians", required: 100}], unlocks: "Wizards" },
  { name: "Builder's Workshop", trophies: 1300, cost: 35000, troops: [{type: "Wizards", required: 100}], unlocks: "Valkyrie" },
  { name: "Pekka's Playhouse", trophies: 1600, cost: 50000, troops: [{type: "Valkyrie", required: 100}], unlocks: "Mini Pekka" },
  { name: "Royal Arena", trophies: 2000, cost: 75000, troops: [{type: "Mini Pekka", required: 100}], unlocks: "Knights" },
  { name: "Frozen Peak", trophies: 2300, cost: 100000, troops: [{type: "Knights", required: 100}], unlocks: "Ice Golem" },
  { name: "Jungle Arena", trophies: 2600, cost: 150000, troops: [{type: "Ice Golem", required: 100}], unlocks: "Dart Goblin" },
  { name: "Hog Mountain", trophies: 3000, cost: 200000, troops: [{type: "Dart Goblin", required: 100}], unlocks: "Hog Riders" }
];
let currentArena = 0;
let unlockedTroops = ["Goblins"];

window.addEventListener('DOMContentLoaded', function() {
  // DOM elements (move these to the top!)
  const trophiesSpan = document.getElementById('trophies');
  const goldSpan = document.getElementById('gold');
  const goldPerSecSpan = document.getElementById('goldPerSec');
  const mineGoldBtn = document.getElementById('mineGoldBtn');
  const battleBtn = document.getElementById('battleBtn');
  const winChanceSpan = document.getElementById('winChance');
  const troopListDiv = document.getElementById('troopList');
  const buyElixirBtn = document.getElementById('buyElixirBtn');
  const elixirCountSpan = document.getElementById('elixirCount');
  const buyGoblinBtn = document.getElementById('buyGoblinBtn');
  const goblinCountSpan = document.getElementById('goblinCount');
  // ... any other DOM elements ...

  // Now you can safely use mineGoldBtn and others:
  mineGoldBtn.addEventListener('click', () => {
    let bonus = 1 + goblins * 0.05;
    let value = mineGoldBase * bonus;
    
    // Check for critical hit
    if (Math.random() * 100 < criticalHitChance) {
      value *= 2;
      // Show critical hit text
      const btnRect = mineGoldBtn.getBoundingClientRect();
      const critText = document.createElement('span');
      critText.textContent = 'CRITICAL!';
      critText.style.position = 'absolute';
      critText.style.left = btnRect.left + 'px';
      critText.style.top = (btnRect.top - 20) + 'px';
      critText.style.color = '#ff4444';
      critText.style.fontWeight = 'bold';
      document.body.appendChild(critText);
      setTimeout(() => critText.remove(), 1000);
    }
    
    gold += value;
    updateDisplay();

    // Floating gold text effect
    const btnRect = mineGoldBtn.getBoundingClientRect();
    const parentRect = document.body.getBoundingClientRect();

    // Create the floating text element
    const floatText = document.createElement('span');
    floatText.textContent = `+${value.toFixed(2)}`;
    floatText.style.position = 'absolute';
    floatText.style.left = (btnRect.left - parentRect.left + Math.random() * btnRect.width * 0.6) + 'px';
    floatText.style.top = (btnRect.top - parentRect.top + Math.random() * btnRect.height * 0.3) + 'px';
    floatText.style.fontFamily = "'Supercell Magic', Arial, sans-serif";
    floatText.style.fontSize = '1.2em';
    floatText.style.fontWeight = 'bold';
    floatText.style.color = '#ffe066';
    floatText.style.textShadow = '1px 1px 0 #2e3d53, 2px 2px 0 #b8860b';
    floatText.style.pointerEvents = 'none';
    floatText.style.opacity = '1';
    floatText.style.transition = 'transform 1s cubic-bezier(.4,2,.6,1), opacity 1s';

    document.body.appendChild(floatText);

    // Trigger the animation (float up and fade out)
    setTimeout(() => {
      floatText.style.transform = `translateY(-48px) scale(1.2)`;
      floatText.style.opacity = '0';
    }, 10);

    // Remove the element after animation
    setTimeout(() => {
      floatText.remove();
    }, 1100);
  });
  let activePopup = null;
  // Prevent double-tap zoom on iOS/Safari, but allow rapid button taps
  let lastTouchEnd = 0;
  document.addEventListener('touchend', function(event) {
    const now = Date.now();
    // Only prevent if not a button or input
    if (
      now - lastTouchEnd <= 300 &&
      !(event.target.closest('button, input, [role="button"]'))
    ) {
      event.preventDefault();
    }
    lastTouchEnd = now;
  }, false);

  // Game state
  let trophies = 9999;
  let gold = 0;
  let goldPerSec = 0;
  let mineGoldBase = 5000;
  let goblins = 0;
  let elixirCollectors = 0;

  // Troop deployment
  let troopTypes = ["Goblins"];
  // Initialize troopOwned to include all possible troops
  let troopOwned = { 
  Goblins: 0, 
  Skeletons: 0, 
  Barbarians: 0, 
  Wizards: 0, 
  Valkyrie: 0, 
  'Mini Pekka': 0, 
  Knights: 0, 
  'Ice Golem': 0, 
  'Dart Goblin': 0, 
  'Hog Riders': 0 
};

let deployedTroops = { 
  Goblins: 0, 
  Skeletons: 0, 
  Barbarians: 0, 
  Wizards: 0, 
  Valkyrie: 0, 
  'Mini Pekka': 0, 
  Knights: 0, 
  'Ice Golem': 0, 
  'Dart Goblin': 0, 
  'Hog Riders': 0 
};

  // Battle state
  let battleInProgress = false; // <-- Add this flag

  // Add to game state section
  let skeletons = 0;
  let criticalHitChance = 0;

  // Game loop for passive gold generation
  setInterval(() => {
    if (!battleInProgress) {
      gold += goldPerSec;
      goldSpan.textContent = Math.floor(gold);
    }
  }, 1000);

  function updateDisplay() {
    // Calculate goldPerSec first
    goldPerSec = elixirCollectors * 1;  // Each collector gives 1 gold/sec

    // Update display elements
    trophiesSpan.textContent = trophies;
    goldSpan.textContent = Math.floor(gold);
    goldPerSecSpan.textContent = goldPerSec;
    elixirCountSpan.textContent = elixirCollectors;
    goblinCountSpan.textContent = goblins;

    // Calculate current mine gold value
    let bonus = 1 + goblins * 0.05;
    let mineGoldValue = mineGoldBase * bonus;
    mineGoldBtn.textContent = `Mine Gold (+${mineGoldValue.toFixed(2)})`;

    // Update troop controls
    troopListDiv.innerHTML = '';
    troopTypes.forEach(type => {
      const div = document.createElement('div');
      div.className = 'troop-controls';
      div.innerHTML = `
        <span>${type} (Owned: ${troopOwned[type]})</span>
        <button onclick="changeTroop('${type}', -1)">-</button>
        <span id="deployed_${type}">${deployedTroops[type]}</span>
        <button onclick="changeTroop('${type}', 1)">+</button>
      `;
      troopListDiv.appendChild(div);
    });

    // Win chance calculation
    let totalTroops = troopTypes.reduce((sum, t) => sum + deployedTroops[t], 0);
    let winChance = 50 + Math.floor(totalTroops / 10);
    winChanceSpan.textContent = winChance;

    // Enable/disable battle button
    battleBtn.disabled = gold < 500 || battleInProgress;

    // Update skeleton count if exists
    const skeletonCountSpan = document.getElementById('skeletonCount');
    if (skeletonCountSpan) {
      skeletonCountSpan.textContent = skeletons;
    }
    criticalHitChance = skeletons * 0.1;

    checkArenaUpgrade();
  }

  // Troop deployment controls
  window.changeTroop = function(type, delta) {
    if (delta === 1 && deployedTroops[type] < troopOwned[type]) {
      deployedTroops[type]++;
    } else if (delta === -1 && deployedTroops[type] > 0) {
      deployedTroops[type]--;
    }
    updateDisplay();
  };

  // Battle logic
  function showBattleProgress(callback) {
    battleInProgress = true; // <-- Set flag
    updateDisplay();         // <-- Update button state

    // Make button unclickable and show countdown
    battleBtn.disabled = true;
    let originalText = battleBtn.textContent;
    let secondsLeft = 1;
    battleBtn.textContent = `Battling (${secondsLeft}s)`;

    // Create a flex container for battleBtn and progressBar if not already present
    if (!battleBtn.parentNode.classList.contains('battle-flex')) {
      const flexDiv = document.createElement('div');
      flexDiv.className = 'battle-flex';
      flexDiv.style.display = 'flex';
      flexDiv.style.alignItems = 'center';
      // Move battleBtn into flexDiv
      battleBtn.parentNode.insertBefore(flexDiv, battleBtn);
      flexDiv.appendChild(battleBtn);
    }
    const flexDiv = battleBtn.parentNode;

    // Remove any existing progress bar
    const oldBar = document.getElementById('battleProgressBar');
    if (oldBar) oldBar.remove();

    // Create progress bar with same height as button, width 120px
    const progressBar = document.createElement('div');
    progressBar.id = 'battleProgressBar';
    progressBar.style.width = '120px';
    progressBar.style.height = `${battleBtn.offsetHeight}px`;
    progressBar.style.background = '#22304a';
    progressBar.style.borderRadius = '8px';
    progressBar.style.marginLeft = '12px';
    progressBar.style.position = 'relative';
    progressBar.style.flexShrink = '0';

    const fill = document.createElement('div');
    fill.style.height = '100%';
    fill.style.width = '0%';
    fill.style.background = '#4caf50';
    fill.style.borderRadius = '8px';
    fill.style.transition = 'width 0.2s linear';
    progressBar.appendChild(fill);

    // Insert progress bar to the right of the button
    flexDiv.appendChild(progressBar);

    let elapsed = 0;
    const duration = 1; // seconds
    const interval = setInterval(() => {
      elapsed++;
      secondsLeft--;
      fill.style.width = `${(elapsed / duration) * 100}%`;
      battleBtn.textContent = `Battling (${secondsLeft}s)`;
      if (elapsed >= duration) {
        clearInterval(interval);
        progressBar.remove();
        battleBtn.textContent = originalText;
        battleInProgress = false; // <-- Reset flag
        updateDisplay();          // <-- Update button state
        callback();
      }
    }, 1000);
  }

  battleBtn.addEventListener('click', () => {
    if (gold < 500 || battleInProgress) return; // <-- Prevent click if in progress
    gold -= 500;
    battleBtn.disabled = true;
    showBattleProgress(() => {
      let totalTroops = troopTypes.reduce((sum, t) => sum + deployedTroops[t], 0);
      let winChance = 50 + Math.floor(totalTroops / 10);
      let win = Math.random() * 100 < winChance;
      
      if (win) {
        let trophiesWon = 26 + Math.floor(Math.random() * 8);
        // Cap trophies at next arena threshold if requirements aren't met
        const nextArena = ARENAS[currentArena + 1];
        if (nextArena && trophies + trophiesWon > nextArena.trophies) {
          trophies = nextArena.trophies;
        } else {
          trophies += trophiesWon;
        }
        alert(`Victory! You won ${trophiesWon} trophies.`);
      } else {
        let trophiesLost = 20 + Math.floor(Math.random() * 8);
        trophies = Math.max(0, trophies - trophiesLost);
        alert(`Defeat! You lost ${trophiesLost} trophies.`);
      }
      
      updateDisplay();
      checkArenaUpgrade();
    });
  });

  // Utility function to show floating cost text for any upgrade button
  function showFloatingCost(btn, amount) {
    const btnRect = btn.getBoundingClientRect();
    const parentRect = document.body.getBoundingClientRect();

    const floatText = document.createElement('span');
    floatText.innerHTML = `-${amount} <img src="img/coin.png" alt="coin" width="18" height="18" style="vertical-align:middle;">`;
    floatText.style.position = 'absolute';
    floatText.style.left = (btnRect.left - parentRect.left + btnRect.width/2 - 20 + Math.random()*20) + 'px';
    floatText.style.top = (btnRect.top - parentRect.top + btnRect.height/2 - 10 + Math.random()*10) + 'px';
    floatText.style.fontFamily = "'Supercell Magic', Arial, sans-serif";
    floatText.style.fontSize = '1.1em';
    floatText.style.fontWeight = 'bold';
    floatText.style.color = '#e74c3c';
    floatText.style.textShadow = '1px 1px 0 #2e3d53, 2px 2px 0 #b8860b';
    floatText.style.pointerEvents = 'none';
    floatText.style.opacity = '1';
    floatText.style.transition = 'transform 1s cubic-bezier(.4,2,.6,1), opacity 1s';

    document.body.appendChild(floatText);

    setTimeout(() => {
      floatText.style.transform = `translateY(-36px) scale(1.1)`;
      floatText.style.opacity = '0';
    }, 10);

    setTimeout(() => {
      floatText.remove();
    }, 1100);
  }

  // Buy Elixir Collector
  buyElixirBtn.addEventListener('click', () => {
    if (gold >= 50) {
      gold -= 50;
      elixirCollectors++;
      goldPerSec = elixirCollectors * 1;
      updateDisplay();
      showFloatingCost(buyElixirBtn, 50);
    }
  });

  // Buy Goblins
  buyGoblinBtn.addEventListener('click', () => {
    if (gold >= 100) {
      gold -= 100;
      goblins++;
      troopOwned.Goblins++;
      updateDisplay();
      showFloatingCost(buyGoblinBtn, 100);
    }
  });

  // Buy 10x Elixir Collectors
document.getElementById('buyElixirBtn10x').addEventListener('click', () => {
  if (gold >= 500) {
    gold -= 500;
    elixirCollectors += 10;
    goldPerSec = elixirCollectors * 1;
    updateDisplay();
    showFloatingCost(buyElixirBtn10x, 500);
  }
});

// Buy 10x Goblins
document.getElementById('buyGoblinBtn10x').addEventListener('click', () => {
  if (gold >= 1000) {
    gold -= 1000;
    goblins += 10;
    troopOwned.Goblins += 10;
    updateDisplay();
    showFloatingCost(buyGoblinBtn10x, 1000);
  }
});

// Modify the buyTroop function to handle 10x purchases
function buyTroop(troopType, cost, amount = 1) {
  const totalCost = cost * amount;
  if (gold >= totalCost) {
    gold -= totalCost;
    troopOwned[troopType] += amount;
    if (troopType === 'Skeletons') {
      skeletons += amount;
    }
    updateDisplay();
    
    // Update the specific troop counter display
    const countSpan = document.getElementById(`${troopType.toLowerCase()}Count`);
    if (countSpan) {
      countSpan.textContent = troopOwned[troopType];
    }
    
    const btn = document.getElementById(`buy${troopType}${amount > 1 ? '10x' : ''}Btn`);
    showFloatingCost(btn, totalCost);
  }
}

    // Add this to your existing JavaScript

    function showInfo(button, description) {
      // Remove any existing popup
      if (activePopup) {
        activePopup.remove();
        activePopup = null;
      }

      // Create popup
      const popup = document.createElement('div');
      popup.className = 'popup';
      popup.textContent = description;
      document.body.appendChild(popup);
      activePopup = popup;

      // Position popup near the button
      const buttonRect = button.getBoundingClientRect();
      popup.style.display = 'block';
      popup.style.left = buttonRect.left + 'px';
      popup.style.top = (buttonRect.bottom + 8) + 'px';

      // Close popup when clicking outside
      const closePopup = (e) => {
        if (!popup.contains(e.target) && e.target !== button) {
          popup.remove();
          activePopup = null;
          document.removeEventListener('click', closePopup);
        }
      };
      
      // Delay adding click listener to prevent immediate closure
      setTimeout(() => {
        document.addEventListener('click', closePopup);
      }, 0);
    }

    window.showInfo = showInfo; // Make showInfo accessible to inline onclick

    // Fix checkArenaUpgrade function
function checkArenaUpgrade() {
  const nextArena = ARENAS[currentArena + 1];
  if (!nextArena) return; // No more arenas

  const upgradeSection = document.querySelector('.upgrade-arena');
  const reqDisplay = document.getElementById('arenaUpgradeRequirements');
  const upgradeBtn = document.getElementById('upgradeArenaBtn');

  // Check if we've hit trophy threshold
  if (trophies >= nextArena.trophies) {
    // Show upgrade section
    upgradeSection.style.display = 'block';
    
    // Check requirements
    const hasGold = gold >= nextArena.cost;
    const hasTroops = nextArena.troops.every(t => troopOwned[t.type] >= t.required);
    
    // Update requirements text
    let reqText = `Requirements for ${nextArena.name}:<br>`;
    reqText += `- ${nextArena.cost} Gold<br>`;
    nextArena.troops.forEach(t => {
      reqText += `- ${t.required} ${t.type}<br>`;
    });
    reqDisplay.innerHTML = reqText;

    // Enable/disable button based on requirements
    upgradeBtn.disabled = !(hasGold && hasTroops);

    // Highlight trophies if can't upgrade
    trophiesSpan.style.color = (!hasGold || !hasTroops) ? '#e74c3c' : '#fff';
  } else {
    upgradeSection.style.display = 'none';
    trophiesSpan.style.color = '#fff';
  }
}
window.buyTroop = buyTroop;

// Upgrade arena button click handler
document.getElementById('upgradeArenaBtn').addEventListener('click', () => {
  const nextArena = ARENAS[currentArena + 1];
  if (!nextArena) return;

  // Check requirements again for safety
  if (gold < nextArena.cost) return;
  for (const t of nextArena.troops) {
    if ((troopOwned[t.type] || 0) < t.required) return;
  }

  // Deduct costs
  gold -= nextArena.cost;
  nextArena.troops.forEach(t => {
    troopOwned[t.type] -= t.required;
    if (troopOwned[t.type] < 0) troopOwned[t.type] = 0;
    
    // Also update individual counters
    if (t.type === 'Goblins') {
      goblins -= t.required;
      if (goblins < 0) goblins = 0;
    }
    if (t.type === 'Skeletons') {
      skeletons -= t.required;
      if (skeletons < 0) skeletons = 0;
    }
    // Add more troop types as needed when you implement their individual counters
  });

  // Advance arena
  currentArena++;

  // Update arena title
  document.querySelector('h2').textContent = ARENAS[currentArena].name;

  // Unlock new troop if available
  if (nextArena.unlocks) {
    const newTroop = nextArena.unlocks;
    if (!unlockedTroops.includes(newTroop)) {
      unlockedTroops.push(newTroop);
      troopTypes.push(newTroop);
      troopOwned[newTroop] = 0;
      deployedTroops[newTroop] = 0;

      // Add new troop upgrade UI to the shop
      const upgradeSection = document.querySelector('.upgrade-section');
      const newUpgradeRow = document.createElement('div');
      newUpgradeRow.className = 'upgrade-row';

      // Define costs and descriptions for each troop
      const troopData = {
        'Skeletons': { cost: 150, description: 'Each Skeleton increases critical hit chance when mining gold by 0.1%' },
        'Barbarians': { cost: 200, description: 'Each Barbarian increases gold earned per battle by 2%' },
        'Wizards': { cost: 300, description: 'Each Wizard increases passive gold generation by 1%' },
        'Valkyrie': { cost: 500, description: 'Each Valkyrie reduces all troop purchase costs by 1% (minimum 50%)' },
        'Mini Pekka': { cost: 750, description: 'Each Mini Pekka gives 0.2% chance to instantly win battles' },
        'Knights': { cost: 1000, description: 'Each Knight increases trophies gained from victories by 1' },
        'Ice Golem': { cost: 1500, description: 'Each Ice Golem reduces trophies lost from defeats by 1' },
        'Dart Goblin': { cost: 2000, description: 'Each Dart Goblin increases passive gold speed by 1%' },
        'Hog Riders': { cost: 3000, description: 'Each Hog Rider gives 0.1% chance to find gold hoard after battle' }
      };

      const cost = troopData[newTroop].cost;
      const description = troopData[newTroop].description;

      newUpgradeRow.innerHTML = `
        <div class="upgrade-label">
          ${newTroop}
          <img src="img/info.png" alt="info" class="info-icon" onclick="showInfo(this, '${description}')">
        </div>
        <div class="button-group">
          <button id="buy${newTroop}Btn" onclick="buyTroop('${newTroop}', ${cost})">
            ${cost}
            <img src="img/coin.png" alt="coin" width="20" height="20" style="vertical-align:middle;">
          </button>
          <button id="buy${newTroop}Btn10x" onclick="buyTroop('${newTroop}', ${cost}, 10)">
            ${cost * 10}
            <img src="img/coin.png" alt="coin" width="20" height="20" style="vertical-align:middle;">
            x10
          </button>
        </div>
        <span>${newTroop}: <span id="${newTroop.toLowerCase()}Count">0</span></span>
      `;
      upgradeSection.appendChild(newUpgradeRow);
    }
  }

  updateDisplay();
  checkArenaUpgrade();
  });
});
  </script>
</body>
</html>
